<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="monetization.css">
  <script src="frontend.js" defer></script>
  <script src="backend.js" defer></script>
  <script src="campaignService.js" defer></script>
  <script src="donation.js" defer></script>
  <script src="premium.js" defer></script>
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:ital,wght@0,300;1,300&display=swap" rel="stylesheet">
  <script src="firebaseConfig.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
  <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />
  <title>Dashboard - FundFlow</title>
</head>

<body>
  <nav>
    <img src="photos/logo.png" alt="FundFlow" class="brand-logo">
    <div class="nav-center">
      <a href="Homepage.html">Home</a>
      <a class="search"><img src="photos/search.png" alt="Search Icon"> search</a>
      <a>donate</a>
      <a class="about" href="About.html">about <img src="photos/triangle-arrow.png" alt="About Arrow"></a>
      <a id="auth-link">
        <span id="nav-username">Signup / Login</span>
        <img id="logout-icon" src="photos/logouticon.png" alt="Logout">
      </a>
    </div>
  </nav>

  <!-- Auth Modal -->
  <div id="auth-modal" class="auth-modal">
    <div class="auth-modal-content">
      <button id="close-auth-modal" class="auth-close-btn">&times;</button>
      <div id="user-info"></div>
      <button id="logout-btn" style="display:none;">Logout</button>
      <div id="auth-container"></div>
    </div>
  </div>

  <main class="dashboard-main">
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>Your Dashboard</h1>
        <p>Manage your campaigns and track their progress</p>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
          <a href="Start-a-camp.html" class="btn-primary">Start New Campaign</a>
        </div>
      </header>

      <!-- My Campaigns Content (only) -->
      <div id="my-campaigns">
        <div class="search-section">
          <div class="search-container">
            <img src="photos/search.png" alt="Search Icon" class="search-icon">
            <input type="text" id="myCampaignSearch" placeholder="Search my campaigns by title, category, description or location..." class="search-input">
            <button id="myClearSearch" class="clear-search-btn" style="display: none;">&times;</button>
          </div>
          <div class="search-filters">
            <select id="myCategoryFilter" class="filter-select">
              <option value="">All Categories</option>
              <option value="Medical">Medical</option>
              <option value="Education">Education</option>
              <option value="Animals">Animals</option>
              <option value="Disaster Relief">Disaster Relief</option>
              <option value="Personal">Personal</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="campaigns-grid" id="myCampaignsList">
          <div class="loading">Loading your campaigns...</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Auth Modal -->
  <div id="auth-modal" class="modal">
    <div class="modal-content">
      <span id="close-auth-modal" class="close">&times;</span>
      <div id="auth-container"></div>
    </div>
  </div>

  <!-- Campaign Modal -->
  <div id="campaign-modal" class="modal">
    <div class="modal-content campaign-modal-content">
      <span id="close-campaign-modal" class="close">&times;</span>
      <div id="campaign-details"></div>
    </div>
  </div>

  <script>
    // Dashboard functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
          // User is logged in, show dashboard
          document.querySelector('.dashboard-main').style.display = 'block';
          initializeDashboard();
        } else {
          // User is not logged in, redirect to homepage
          window.location.href = 'Homepage.html';
        }
      });
    });

    function initializeDashboard() {
      // Only My Campaigns now
      loadMyCampaigns();
    }

    // Load user's campaigns
    async function loadMyCampaigns() {
      const container = document.getElementById('myCampaignsList');
      const user = firebase.auth().currentUser;
      
      console.log('Loading my campaigns...');
      console.log('Current user:', user);
      
      if (!user) {
        container.innerHTML = '<div class="no-campaigns">Please log in to view your campaigns.</div>';
        return;
      }

      try {
        console.log('Fetching campaigns for user ID:', user.uid);
        const campaigns = await campaignService.getUserCampaigns(user.uid);
        console.log('Retrieved campaigns:', campaigns);
        myCampaignsData = campaigns; // store for search
        displayCampaigns(campaigns, container, true);
        if (!mySearchSetup) setupMySearchFunctionality();
      } catch (error) {
        console.error('Error loading campaigns:', error);
        container.innerHTML = '<div class="error">Error loading your campaigns. Please try again.</div>';
      }
    }

    // Store my campaigns for search
    let myCampaignsData = [];
    let mySearchSetup = false;

    // My Campaigns: setup simple search
    function setupMySearchFunctionality() {
      const searchInput = document.getElementById('myCampaignSearch');
      const categoryFilter = document.getElementById('myCategoryFilter');
      const clearSearchBtn = document.getElementById('myClearSearch');

      if (!searchInput) return;
      mySearchSetup = true;

      searchInput.addEventListener('input', function() {
        const hasText = this.value.trim().length > 0;
        clearSearchBtn.style.display = hasText ? 'block' : 'none';
        filterMyCampaigns();
      });
      categoryFilter.addEventListener('change', filterMyCampaigns);
      clearSearchBtn.addEventListener('click', function() {
        searchInput.value = '';
        categoryFilter.value = '';
        this.style.display = 'none';
        filterMyCampaigns();
      });
    }

    function filterMyCampaigns() {
      const searchTerm = document.getElementById('myCampaignSearch').value.toLowerCase();
      const selectedCategory = document.getElementById('myCategoryFilter').value;
      const container = document.getElementById('myCampaignsList');

      let filtered = myCampaignsData.filter(c => {
        const t = (c.title||'').toLowerCase();
        const cat = (c.category||'').toLowerCase();
        const loc = (c.location||'').toLowerCase();
        const desc = (c.description||'').toLowerCase();
        const org = (c.organizer?.name||'').toLowerCase();
        const matchSearch = !searchTerm || t.includes(searchTerm) || cat.includes(searchTerm) || loc.includes(searchTerm) || desc.includes(searchTerm) || org.includes(searchTerm);
        const matchCategory = !selectedCategory || c.category === selectedCategory;
        return matchSearch && matchCategory;
      });

      displayCampaigns(filtered, container, true);
    }

    // Display campaigns in grid
    function displayCampaigns(campaigns, container, isMyCampaigns = false) {
      if (campaigns.length === 0) {
        container.innerHTML = '<div class="no-campaigns">No campaigns found.</div>';
        return;
      }

      container.innerHTML = campaigns.map((campaign, index) => {
        // Calculate progress (for now, using random progress, later can be real data)
        const progress = Math.floor(Math.random() * 80) + 10; // Random progress between 10-90%
        const raised = Math.floor((campaign.goal * progress) / 100);
        
        // Get campaign image (use uploaded image if available, otherwise default)
        const campaignImage = campaign.uploadedImage || `photos/projectimg${Math.floor(Math.random() * 3) + 1}.png`;
        
        return `
          <div class="campaign-card" data-campaign-id="${campaign.id}">
            <img src="${campaignImage}" alt="${campaign.title}" class="campaign-img">
            <div class="campaign-content-area">
              <span class="campaign-category-badge">${campaign.category}</span>
              <h3 class="campaign-title">${campaign.title}</h3>
              <p class="campaign-description">${campaign.description.substring(0, 80)}...</p>
              <div class="progress-bar">
                <div class="progress" style="width: ${progress}%"></div>
              </div>
              <div class="progress-info">
                ₹${raised.toLocaleString()} raised of ₹${campaign.goal.toLocaleString()} goal
              </div>
              <button class="donate-btn" onclick="donateToCampaign('${campaign.id}')">Donate</button>
              ${isMyCampaigns ? `
                <div class="campaign-actions" style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                  <button class="btn-secondary" onclick="viewCampaign('${campaign.id}')" style="font-size: 0.8rem; padding: 5px 10px;">View</button>
                  <button class="btn-danger" onclick="deleteCampaign('${campaign.id}')" style="font-size: 0.8rem; padding: 5px 10px;">Delete</button>
                  ${campaign.status === 'draft' ? `<button class="btn-primary" onclick="publishCampaign('${campaign.id}')" style="font-size: 0.8rem; padding: 5px 10px;">Publish</button>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // View campaign details
    async function viewCampaign(campaignId) {
      const campaign = await campaignService.getCampaignById(campaignId);
      if (!campaign) return;

      const modal = document.getElementById('campaign-modal');
      const content = document.getElementById('campaign-details');
      
      content.innerHTML = `
        <div class="campaign-detail">
          <h2>${campaign.title}</h2>
          <div class="campaign-meta">
            <span class="category">${campaign.category}</span>
            <span class="status ${campaign.status}">${campaign.status}</span>
          </div>
          <div class="campaign-goal-large">
            <span class="amount">₹${campaign.goal.toLocaleString()}</span>
            <span class="label">Goal Amount</span>
          </div>
          <div class="campaign-description-full">
            <h3>Description</h3>
            <p>${campaign.description}</p>
          </div>
          <div class="campaign-organizer-info">
            <h3>Organizer Details</h3>
            <p><strong>Name:</strong> ${campaign.organizer.name}</p>
            <p><strong>Relation:</strong> ${campaign.organizer.relation}</p>
            ${campaign.organizer.ngo ? `<p><strong>NGO:</strong> ${campaign.organizer.ngo}</p>` : ''}
          </div>
          <div class="campaign-dates">
            <p><strong>Created:</strong> ${new Date(campaign.createdAt?.toDate()).toLocaleDateString()}</p>
            ${campaign.publishedAt ? `<p><strong>Published:</strong> ${new Date(campaign.publishedAt.toDate()).toLocaleDateString()}</p>` : ''}
          </div>
        </div>
      `;
      
      modal.style.display = 'block';
    }

    // Delete campaign
    async function deleteCampaign(campaignId) {
      if (!confirm('Are you sure you want to delete this campaign?')) return;
      
      const result = await campaignService.deleteCampaign(campaignId);
      if (result.success) {
        alert('Campaign deleted successfully');
        loadMyCampaigns();
      } else {
        alert('Error deleting campaign: ' + result.error);
      }
    }

    // Publish campaign
    async function publishCampaign(campaignId) {
      const result = await campaignService.updateCampaignStatus(campaignId, 'published');
      if (result.success) {
        alert('Campaign published successfully');
        loadMyCampaigns();
      } else {
        alert('Error publishing campaign: ' + result.error);
      }
    }


    // Donate to campaign
    function donateToCampaign(campaignId) {
      // For now, show an alert. Later this can be integrated with payment gateway
      alert('Donation functionality coming soon! This will integrate with payment gateway.');
    }

    // Close modals
    document.getElementById('close-campaign-modal').onclick = function() {
      document.getElementById('campaign-modal').style.display = 'none';
    };

    window.onclick = function(event) {
      const campaignModal = document.getElementById('campaign-modal');
      if (event.target === campaignModal) {
        campaignModal.style.display = 'none';
      }
    };
  </script>
</body>
</html>
